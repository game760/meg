<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>运算题生成器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-100-M/noto-sans-sc/4.003/noto-sans-sc.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-100-M/roboto/4.0.3-1/roboto.css" media="print" onload="this.media='all'">
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4338CA',
            secondary: '#10B981',
            accent: '#F59E0B',
            neutral: '#F3F4F6',
          },
          fontFamily: {
            sans: [
              '"Noto Sans SC"',
              'Roboto',
              'system-ui', 
              'sans-serif'
            ],
          },
          boxShadow: {
            'card': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03)',
            'card-hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
          }
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .btn-effect {
        @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5 active:translate-y-0;
      }
      .input-focus {
        @apply focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none;
      }
      .setting-group {
        @apply mb-6 pb-6 border-b border-gray-100 last:border-0 last:mb-0 last:pb-0;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      .page-shadow {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05);
      }
      .page-transition {
        transition: all 0.3s ease;
      }
      .page-transition:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .lang-switch {
        @apply px-3 py-1.5 rounded-full text-sm font-medium cursor-pointer transition-all;
      }
      .lang-switch.active {
        @apply bg-primary text-white;
      }
      .lang-switch:not(.active) {
        @apply bg-gray-100 text-gray-700 hover:bg-gray-200;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans text-gray-800">
  <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300">
    <div class="container mx-auto px-4 py-4 flex flex-wrap justify-between items-center">
      <div class="flex items-center space-x-3">
        <div class="bg-primary/10 p-2 rounded-lg">
          <i class="fa fa-calculator text-primary text-xl"></i>
        </div>
        <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
          <span class="lang-zh">运算题生成器</span>
          <span class="lang-en hidden">Math Exercise Generator</span>
        </h1>
      </div>
      <div class="flex items-center space-x-4 mt-2 md:mt-0">
        <div class="flex space-x-2">
          <div id="lang-zh" class="lang-switch active" data-lang="zh">中文</div>
          <div id="lang-en" class="lang-switch" data-lang="en">English</div>
        </div>
        <a href="https://github.com/game760/opg" target="_blank" rel="noopener noreferrer" 
           class="text-gray-600 hover:text-gray-900 transition-colors">
          <i class="fa fa-github text-2xl"></i>
        </a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 max-w-7xl opacity-0 transition-opacity duration-500">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-card p-6 transition-all duration-300 hover:shadow-card-hover transform hover:-translate-y-1">
          <h2 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
            <i class="fa fa-sliders text-primary mr-2"></i> 
            <span class="lang-zh">题目设置</span>
            <span class="lang-en hidden">Exercise Settings</span>
          </h2>
          
          <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6 rounded-r-lg">
            <div class="flex">
              <div class="flex-shrink-0">
                <i class="fa fa-lightbulb-o text-amber-500"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm text-amber-700">
                  <strong class="lang-zh">使用提醒：</strong>
                  <strong class="lang-en hidden">Tips：</strong>
                  <span class="lang-zh">请根据右侧预览调整题数、字号、行列设置等，亦可通过观察生成文件进行调整，最终完美再进行打印。</span>
                  <span class="lang-en hidden">Adjust settings based on preview, you can also check generated files before final printing.</span>
                </p>
              </div>
            </div>
          </div>
          
          <!-- 题目数量设置 -->
          <div class="setting-group">
            <label for="questionCount" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-list-ol text-primary mr-1"></i> 
              <span class="lang-zh">题目数量</span>
              <span class="lang-en hidden">Number of questions</span>
            </label>
            <div class="flex items-center">
              <input 
                type="number" 
                id="questionCount" 
                min="1" 
                max="500" 
                value="240" 
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus"
              >
              <span class="ml-2 text-gray-500 lang-zh">题</span>
              <span class="ml-2 text-gray-500 lang-en hidden">questions</span>
            </div>
          </div>

          <!-- 新增：分段设置 -->
          <div class="setting-group">
            <label for="sectionCount" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-columns text-primary mr-1"></i> 
              <span class="lang-zh">分段数量</span>
              <span class="lang-en hidden">Section Count</span>
            </label>
            <div class="flex items-center">
              <input 
                type="number" 
                id="sectionCount" 
                min="1" 
                max="20" 
                value="1" 
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus"
              >
              <span class="ml-2 text-gray-500 lang-zh">段</span>
              <span class="ml-2 text-gray-500 lang-en hidden">sections</span>
            </div>
            <p class="mt-2 text-xs text-gray-500 lang-zh">
              会将总题数平均分配到每一段中
            </p>
            <p class="mt-2 text-xs text-gray-500 lang-en hidden">
              Total questions will be evenly distributed to each section
            </p>
          </div>
          
          <!-- 数字范围设置 -->
          <div class="setting-group">
            <label for="numberRange" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-arrows-h text-primary mr-1"></i> 
              <span class="lang-zh">数字范围（以内）</span>
              <span class="lang-en hidden">Number range (max)</span>
            </label>
            <div class="flex items-center">
              <input 
                type="number" 
                id="numberRange" 
                min="10" 
                max="1000" 
                step="10"
                value="20" 
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus"
              >
              <span class="ml-2 text-gray-500 lang-zh">以内</span>
              <span class="ml-2 text-gray-500 lang-en hidden">max</span>
            </div>
          </div>
          
          <!-- 纸张大小设置 -->
          <div class="setting-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-file-o text-primary mr-1"></i> 
              <span class="lang-zh">纸张大小</span>
              <span class="lang-en hidden">Paper size</span>
            </label>
            <div class="grid grid-cols-1 gap-3">
              <div class="relative">
                <input 
                  type="radio" 
                  id="paperA4" 
                  name="paperSize" 
                  value="a4" 
                  checked
                  class="sr-only peer"
                >
                <label 
                  for="paperA4" 
                  class="block text-center px-3 py-2.5 border border-gray-300 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-primary/5"
                >
                  A4 (210×297mm)
                </label>
              </div>
            </div>
          </div>
          
          <!-- 字号设置 -->
          <div class="setting-group">
            <label for="fontSize" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-text-height text-primary mr-1"></i> 
              <span class="lang-zh">字号大小</span>
              <span class="lang-en hidden">Font size</span>
            </label>
            <div class="flex items-center">
              <input 
                type="number" 
                id="fontSize" 
                min="8" 
                max="24" 
                value="14" 
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus"
              >
              <span class="ml-2 text-gray-500">px</span>
            </div>
          </div>

          <!-- 新增：字体加粗选项 -->
          <div class="setting-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-bold text-primary mr-1"></i> 
              <span class="lang-zh">字体样式</span>
              <span class="lang-en hidden">Font Style</span>
            </label>
            <div class="flex items-center space-x-4">
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="fontBold" 
                  class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"
                >
                <label for="fontBold" class="ml-2 text-sm text-gray-700">
                  <span class="lang-zh">加粗题目文字</span>
                  <span class="lang-en hidden">Bold Question Text</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- 行列设置 -->
          <div class="setting-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-th text-primary mr-1"></i> 
              <span class="lang-zh">行列设置</span>
              <span class="lang-en hidden">Grid layout</span>
            </label>
            <div class="grid grid-cols-2 gap-3">
              <div class="flex items-center">
                <label for="rowCount" class="text-sm text-gray-700 mr-2 lang-zh">行数:</label>
                <label for="rowCount" class="text-sm text-gray-700 mr-2 lang-en hidden">Rows:</label>
                <input 
                  type="number" 
                  id="rowCount" 
                  min="5" 
                  max="40" 
                  value="40" 
                  class="w-full px-3 py-2.5 border border-gray-300 rounded-lg input-focus"
                >
              </div>
              <div class="flex items-center">
                <label for="colCount" class="text-sm text-gray-700 mr-2 lang-zh">列数:</label>
                <label for="colCount" class="text-sm text-gray-700 mr-2 lang-en hidden">Columns:</label>
                <input 
                  type="number" 
                  id="colCount" 
                  min="1" 
                  max="6" 
                  value="6" 
                  class="w-full px-3 py-2.5 border border-gray-300 rounded-lg input-focus"
                >
              </div>
            </div>
          </div>
          
          <!-- 答案设置 -->
          <div class="setting-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-check-square-o text-primary mr-1"></i> 
              <span class="lang-zh">答案设置</span>
              <span class="lang-en hidden">Answer settings</span>
            </label>
            <div class="space-y-3">
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="includeAnswers" 
                  checked 
                  class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"
                >
                <label for="includeAnswers" class="ml-2 text-sm text-gray-700">
                  <span class="lang-zh">导出时包含答案</span>
                  <span class="lang-en hidden">Include answers in export</span>
                </label>
              </div>
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="answersOnNewPage" 
                  checked 
                  class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"
                >
                <label for="answersOnNewPage" class="ml-2 text-sm text-gray-700">
                  <span class="lang-zh">答案单独占页</span>
                  <span class="lang-en hidden">Answers on separate pages</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- 运算类型设置 -->
          <div class="setting-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-calculator text-primary mr-1"></i> 
              <span class="lang-zh">运算类型</span>
              <span class="lang-en hidden">Operation types</span>
            </label>
            <div class="grid grid-cols-2 gap-3">
              <div class="flex items-center">
                <input type="checkbox" id="addition" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="addition" class="ml-2 text-sm text-gray-700">
                  <span class="lang-zh">加法 (+)</span>
                  <span class="lang-en hidden">Addition (+)</span>
                </label>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="subtraction" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="subtraction" class="ml-2 text-sm text-gray-700">
                  <span class="lang-zh">减法 (-)</span>
                  <span class="lang-en hidden">Subtraction (-)</span>
                </label>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="multiplication" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="multiplication" class="ml-2 text-sm text-gray-700">
                  <span class="lang-zh">乘法 (×)</span>
                  <span class="lang-en hidden">Multiplication (×)</span>
                </label>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="division" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="division" class="ml-2 text-sm text-gray-700">
                  <span class="lang-zh">除法 (÷)</span>
                  <span class="lang-en hidden">Division (÷)</span>
                </label>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="comparison" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="comparison" class="ml-2 text-sm text-gray-700">
                  <span class="lang-zh">比较 (<, >, =)</span>
                  <span class="lang-en hidden">Comparison (<, >, =)</span>
                </label>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="brackets" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="brackets" class="ml-2 text-sm text-gray-700">
                  <span class="lang-zh">括号运算(,）</span>
                  <span class="lang-en hidden">Bracket operations(,)</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- 格式设置 -->
          <div class="setting-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-file-text-o text-primary mr-1"></i> 
              <span class="lang-zh">导出格式</span>
              <span class="lang-en hidden">Export format</span>
            </label>
            <div class="grid grid-cols-1 gap-3">
              <div class="relative">
                <input 
                  type="radio" 
                  id="formatPdf" 
                  name="format" 
                  value="pdf" 
                  checked
                  class="sr-only peer"
                >
                <label 
                  for="formatPdf" 
                  class="block text-center px-3 py-3 border border-gray-300 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-primary/5"
                >
                  <i class="fa fa-file-pdf-o block text-lg mb-1 text-red-600"></i>
                  <span class="text-sm">PDF</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- 按钮区域 -->
          <div class="flex flex-col sm:flex-row gap-3 pt-4">
            <button 
              id="generateBtn" 
              class="flex-1 bg-primary text-white py-3 px-4 rounded-lg font-medium btn-effect flex items-center justify-center"
            >
              <i class="fa fa-refresh mr-2"></i> 
              <span class="lang-zh">生成题目</span>
              <span class="lang-en hidden">Generate questions</span>
            </button>
            <button 
              id="exportBtn" 
              class="flex-1 bg-secondary text-white py-3 px-4 rounded-lg font-medium btn-effect flex items-center justify-center"
            >
              <i class="fa fa-download mr-2"></i> 
              <span class="lang-zh">导出PDF</span>
              <span class="lang-en hidden">Export PDF</span>
            </button>
          </div>
        </div>
      </div>
      
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-card p-6 transition-all duration-300 hover:shadow-card-hover h-full">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold text-gray-800 flex items-center">
              <i class="fa fa-list-alt text-primary mr-2"></i> 
              <span class="lang-zh">生成的题目</span>
              <span class="lang-en hidden">Generated questions</span>
            </h2>
            <div class="text-sm text-gray-500 bg-neutral px-3 py-1 rounded-full">
              <span id="questionStats" class="lang-zh">0 题</span>
              <span id="questionStats-en" class="lang-en hidden">0 questions</span>
              · <span id="pageStats" class="lang-zh">0 页</span>
              <span id="pageStats-en" class="lang-en hidden">0 pages</span>
            </div>
          </div>
          
          <div id="initialMessage" class="text-center py-16 text-gray-500">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 mb-4">
              <i class="fa fa-lightbulb-o text-2xl text-primary"></i>
            </div>
            <p class="text-gray-600 lang-zh">请设置题目参数并点击"生成题目"按钮</p>
            <p class="text-gray-600 lang-en hidden">Please set parameters and click "Generate questions"</p>
          </div>
          
          <div id="paginationControls" class="hidden mb-6 flex justify-between items-center">
            <button id="prevPage" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 btn-effect disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none" disabled>
              <i class="fa fa-chevron-left mr-1"></i> 
              <span class="lang-zh">上一页</span>
              <span class="lang-en hidden">Previous</span>
            </button>
            <div class="text-sm text-gray-600">
              <span class="lang-zh">第</span>
              <span class="lang-en hidden">Page</span>
              <span id="currentPage">1</span>
              <span class="lang-zh">页 / 共</span>
              <span class="lang-en hidden">of</span>
              <span id="totalPages">0</span>
              <span class="lang-zh">页</span>
              <span class="lang-en hidden">pages</span>
            </div>
            <button id="nextPage" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 btn-effect disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none" disabled>
              <span class="lang-zh">下一页</span>
              <span class="lang-en hidden">Next</span>
              <i class="fa fa-chevron-right ml-1"></i>
            </button>
          </div>
          
          <div id="questionsContainer" class="hidden">
            <div id="questionsPages" class="space-y-8">
              <!-- 页面内容动态生成 -->
            </div>
          </div>
          
          <div class="mt-8 pt-6 border-t border-gray-100">
            <button id="toggleAnswersBtn" class="text-primary hover:text-primary/80 text-sm font-medium flex items-center btn-effect px-2 py-1 rounded">
              <i class="fa fa-eye mr-1"></i>
              <span class="lang-zh">显示答案</span>
              <span class="lang-en hidden">Show answers</span>
            </button>
            
            <div id="answersPaginationControls" class="hidden mt-4 flex justify-between items-center">
              <button id="prevAnswerPage" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 btn-effect disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none" disabled>
                <i class="fa fa-chevron-left mr-1"></i> 
                <span class="lang-zh">上一页</span>
                <span class="lang-en hidden">Previous</span>
              </button>
              <div class="text-sm text-gray-600">
                <span class="lang-zh">第</span>
                <span class="lang-en hidden">Page</span>
                <span id="currentAnswerPage">1</span>
                <span class="lang-zh">页 / 共</span>
                <span class="lang-en hidden">of</span>
                <span id="totalAnswerPages">0</span>
                <span class="lang-zh">页</span>
                <span class="lang-en hidden">pages</span>
              </div>
              <button id="nextAnswerPage" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 btn-effect disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none" disabled>
                <span class="lang-zh">下一页</span>
                <span class="lang-en hidden">Next</span>
                <i class="fa fa-chevron-right ml-1"></i>
              </button>
            </div>
            
            <div id="answersContainer" class="hidden mt-4 space-y-8">
              <!-- 答案页面动态生成 -->
            </div>
          </div>
          
          <div id="loadingIndicator" class="hidden text-center py-16">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent mb-4"></div>
            <p class="text-gray-600 lang-zh">正在生成题目...</p>
            <p class="text-gray-600 lang-en hidden">Generating questions...</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-white border-t border-gray-100 mt-12">
    <div class="container mx-auto px-4 py-8">
      <div class="text-center text-gray-500 text-sm">
        <p class="lang-zh">运算题生成器 &copy; 2023 - 灵活排版，自定义练习</p>
        <p class="lang-en hidden">Math Exercise Generator &copy; 2023 - Flexible layout, custom practice</p>
        <p class="mt-1 lang-zh">专为教育场景设计，提升练习效率</p>
        <p class="mt-1 lang-en hidden">Designed for educational scenarios to improve practice efficiency</p>
      </div>
    </div>
  </footer>

  <script>
    let generatedQuestions = [];
    let generatedAnswers = [];
    let questionPages = [];
    let answerPages = [];
    let currentPage = 1;
    let currentAnswerPage = 1;
    let currentLang = 'zh';
    // 新增：分段相关变量
    let sectionedQuestions = [];
    let sectionedAnswers = [];
    
    const generateBtn = document.getElementById('generateBtn');
    const exportBtn = document.getElementById('exportBtn');
    const toggleAnswersBtn = document.getElementById('toggleAnswersBtn');
    const questionCountInput = document.getElementById('questionCount');
    const numberRangeInput = document.getElementById('numberRange');
    const fontSizeInput = document.getElementById('fontSize');
    const rowCountInput = document.getElementById('rowCount');
    const colCountInput = document.getElementById('colCount');
    const includeAnswersCheckbox = document.getElementById('includeAnswers');
    const answersOnNewPageCheckbox = document.getElementById('answersOnNewPage');
    const questionsPages = document.getElementById('questionsPages');
    const answersContainer = document.getElementById('answersContainer');
    const initialMessage = document.getElementById('initialMessage');
    const questionsContainer = document.getElementById('questionsContainer');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const questionStats = document.getElementById('questionStats');
    const questionStatsEn = document.getElementById('questionStats-en');
    const pageStats = document.getElementById('pageStats');
    const pageStatsEn = document.getElementById('pageStats-en');
    const header = document.querySelector('header');
    // 新增：分段和加粗DOM元素
    const sectionCountInput = document.getElementById('sectionCount');
    const fontBoldCheckbox = document.getElementById('fontBold');
    
    const paginationControls = document.getElementById('paginationControls');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const currentPageEl = document.getElementById('currentPage');
    const totalPagesEl = document.getElementById('totalPages');
    
    const answersPaginationControls = document.getElementById('answersPaginationControls');
    const prevAnswerPageBtn = document.getElementById('prevAnswerPage');
    const nextAnswerPageBtn = document.getElementById('nextAnswerPage');
    const currentAnswerPageEl = document.getElementById('currentAnswerPage');
    const totalAnswerPagesEl = document.getElementById('totalAnswerPages');
    
    const langZhBtn = document.getElementById('lang-zh');
    const langEnBtn = document.getElementById('lang-en');
    
    // 计算每页题目数量
    function getQuestionsPerPage() {
      const rowCount = parseInt(rowCountInput.value) || 40;
      const colCount = parseInt(colCountInput.value) || 6;
      return rowCount * colCount;
    }
    
    // 新增：分段处理函数
    function splitIntoSections(questions, answers) {
      const totalQuestions = questions.length;
      const sectionCount = parseInt(sectionCountInput.value) || 1;
      const questionsPerSection = Math.ceil(totalQuestions / sectionCount);
      
      const sectionedQ = [];
      const sectionedA = [];
      
      for (let i = 0; i < sectionCount; i++) {
        const start = i * questionsPerSection;
        const end = Math.min((i + 1) * questionsPerSection, totalQuestions);
        sectionedQ.push(questions.slice(start, end));
        sectionedA.push(answers.slice(start, end));
      }
      
      return [sectionedQ, sectionedA];
    }
    
    // 分割题目为页面组
    function splitIntoPages(items) {
      const pages = [];
      const questionsPerPage = getQuestionsPerPage();
      
      for (let i = 0; i < items.length; i += questionsPerPage) {
        pages.push(items.slice(i, i + questionsPerPage));
      }
      
      return pages;
    }
    
    function updatePagination() {
      const totalPages = questionPages.length;
      currentPageEl.textContent = currentPage;
      totalPagesEl.textContent = totalPages;
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
      
      const pageElements = questionsPages.querySelectorAll('.question-page');
      pageElements.forEach((page, index) => {
        page.classList.toggle('hidden', index + 1 !== currentPage);
      });
      
      if (currentLang === 'zh') {
        pageStats.textContent = `${totalPages} 页`;
      } else {
        pageStatsEn.textContent = `${totalPages} pages`;
      }
    }
    
    function updateAnswerPagination() {
      const totalAnswerPages = answerPages.length;
      currentAnswerPageEl.textContent = currentAnswerPage;
      totalAnswerPagesEl.textContent = totalAnswerPages;
      prevAnswerPageBtn.disabled = currentAnswerPage <= 1;
      nextAnswerPageBtn.disabled = currentAnswerPage >= totalAnswerPages;
      
      const answerPageElements = answersContainer.querySelectorAll('.answer-page');
      answerPageElements.forEach((page, index) => {
        page.classList.toggle('hidden', index + 1 !== currentAnswerPage);
      });
    }
    
    function updateLayoutAndPagination() {
      if (generatedQuestions.length === 0) return;
      
      questionPages = splitIntoPages(generatedQuestions);
      answerPages = splitIntoPages(generatedAnswers);
      currentPage = 1;
      currentAnswerPage = 1;
      
      renderQuestionPages();
      renderAnswerPages();
      updatePagination();
      updateAnswerPagination();
    }
    
    rowCountInput.addEventListener('input', updateLayoutAndPagination);
    colCountInput.addEventListener('input', updateLayoutAndPagination);
    fontSizeInput.addEventListener('input', updateLayoutAndPagination);
    // 新增：分段数变化时重新渲染
    sectionCountInput.addEventListener('input', updateLayoutAndPagination);
    fontBoldCheckbox.addEventListener('change', updateLayoutAndPagination);
    
    prevPageBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        updatePagination();
        scrollToTopOfContainer();
      }
    });
    
    nextPageBtn.addEventListener('click', () => {
      if (currentPage < questionPages.length) {
        currentPage++;
        updatePagination();
        scrollToTopOfContainer();
      }
    });
    
    prevAnswerPageBtn.addEventListener('click', () => {
      if (currentAnswerPage > 1) {
        currentAnswerPage--;
        updateAnswerPagination();
        scrollToTopOfAnswers();
      }
    });
    
    nextAnswerPageBtn.addEventListener('click', () => {
      if (currentAnswerPage < answerPages.length) {
        currentAnswerPage++;
        updateAnswerPagination();
        scrollToTopOfAnswers();
      }
    });
    
    function scrollToTopOfContainer() {
      questionsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function scrollToTopOfAnswers() {
      answersContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    window.addEventListener('scroll', () => {
      if (window.scrollY > 10) {
        header.classList.add('shadow');
      } else {
        header.classList.remove('shadow');
      }
    });
    
    generateBtn.addEventListener('click', generateQuestions);
    exportBtn.addEventListener('click', exportQuestions);
    
    toggleAnswersBtn.addEventListener('click', () => {
      const isHidden = answersContainer.classList.toggle('hidden');
      const icon = toggleAnswersBtn.querySelector('i');
      const zhText = toggleAnswersBtn.querySelector('.lang-zh');
      const enText = toggleAnswersBtn.querySelector('.lang-en');
      
      if (isHidden) {
        icon.className = 'fa fa-eye mr-1';
        zhText.textContent = '显示答案';
        enText.textContent = 'Show answers';
        answersPaginationControls.classList.add('hidden');
      } else {
        icon.className = 'fa fa-eye-slash mr-1';
        zhText.textContent = '隐藏答案';
        enText.textContent = 'Hide answers';
        answersPaginationControls.classList.remove('hidden');
        updateAnswerPagination();
      }
    });
    
    langZhBtn.addEventListener('click', () => switchLanguage('zh'));
    langEnBtn.addEventListener('click', () => switchLanguage('en'));
    
    function switchLanguage(lang) {
      if (lang === currentLang) return;
      
      currentLang = lang;
      
      if (lang === 'zh') {
        langZhBtn.classList.add('active');
        langEnBtn.classList.remove('active');
      } else {
        langZhBtn.classList.remove('active');
        langEnBtn.classList.add('active');
      }
      
      document.querySelectorAll('.lang-zh').forEach(el => {
        el.classList.toggle('hidden', lang !== 'zh');
      });
      document.querySelectorAll('.lang-en').forEach(el => {
        el.classList.toggle('hidden', lang !== 'en');
      });
      
      const questionCount = generatedQuestions.length;
      const pageCount = questionPages.length;
      
      if (lang === 'zh') {
        questionStats.classList.remove('hidden');
        questionStatsEn.classList.add('hidden');
        pageStats.classList.remove('hidden');
        pageStatsEn.classList.add('hidden');
        questionStats.textContent = `${questionCount} 题`;
        pageStats.textContent = `${pageCount} 页`;
      } else {
        questionStats.classList.add('hidden');
        questionStatsEn.classList.remove('hidden');
        pageStats.classList.add('hidden');
        pageStatsEn.classList.remove('hidden');
        questionStatsEn.textContent = `${questionCount} questions`;
        pageStatsEn.textContent = `${pageCount} pages`;
      }
      
      updatePagination();
      updateAnswerPagination();
    }
    
    function getPaperDimensions() {
      return {
        width: 210,
        height: 297,
        margin: 20,
        contentWidth: 210 - 40,
        contentHeight: 297 - 40
      };
    }
    
    // 优化：渲染题目页面 - 支持分段和加粗
    function renderQuestionPages() {
      questionsPages.innerHTML = '';
      const colCount = parseInt(colCountInput.value) || 6;
      const fontSize = parseInt(fontSizeInput.value) || 14;
      const isBold = fontBoldCheckbox.checked;
      const sectionCount = parseInt(sectionCountInput.value) || 1;
      
      // 先进行分段处理
      [sectionedQuestions, sectionedAnswers] = splitIntoSections(generatedQuestions, generatedAnswers);
      
      // 构建包含分段标题的完整题目列表
      let fullQuestionList = [];
      sectionedQuestions.forEach((section, sectionIndex) => {
        // 添加分段标题标记
        fullQuestionList.push({
          type: 'section-title',
          index: sectionIndex + 1
        });
        // 添加当前段的题目
        section.forEach(q => fullQuestionList.push({
          type: 'question',
          content: q
        }));
      });
      
      // 重新分页（处理分段标题）
      const questionsPerPage = getQuestionsPerPage();
      const newQuestionPages = [];
      let currentPageItems = [];
      let currentQuestionCount = 0;
      
      fullQuestionList.forEach(item => {
        if (item.type === 'section-title') {
          // 标题直接加入当前页
          currentPageItems.push(item);
        } else {
          // 题目需要计数
          if (currentQuestionCount >= questionsPerPage) {
            newQuestionPages.push(currentPageItems);
            currentPageItems = [];
            currentQuestionCount = 0;
          }
          currentPageItems.push(item);
          currentQuestionCount++;
        }
      });
      
      if (currentPageItems.length > 0) {
        newQuestionPages.push(currentPageItems);
      }
      
      // 渲染最终页面
      newQuestionPages.forEach((page, pageIndex) => {
        const pageElement = document.createElement('div');
        pageElement.className = `question-page ${pageIndex === 0 ? '' : 'hidden'} page-shadow rounded-lg p-6 bg-white page-transition`;
        
        pageElement.innerHTML = `
          <h3 class="text-sm text-gray-500 mb-4">
            <span class="lang-zh">第 ${pageIndex + 1} 页</span>
            <span class="lang-en hidden">Page ${pageIndex + 1}</span>
          </h3>
        `;
        
        const gridElement = document.createElement('div');
        gridElement.className = `grid grid-cols-${colCount} gap-3`;
        
        page.forEach(item => {
          if (item.type === 'section-title') {
            // 渲染分段标题
            const titleEl = document.createElement('div');
            titleEl.className = `col-span-${colCount} text-center font-semibold text-primary mb-4 ${isBold ? 'font-bold' : ''}`;
            titleEl.style.fontSize = `${fontSize + 2}px`;
            titleEl.textContent = currentLang === 'zh' 
              ? `第 ${item.index} 段` 
              : `Section ${item.index}`;
            gridElement.appendChild(titleEl);
          } else {
            // 渲染普通题目
            const questionEl = document.createElement('div');
            questionEl.className = `flex items-center p-3 border border-gray-100 rounded-lg hover:bg-neutral transition-colors ${isBold ? 'font-bold' : ''}`;
            questionEl.style.fontSize = `${fontSize}px`;
            
            if (item.content.includes('____')) {
              questionEl.innerHTML = `<span class="text-gray-800">${item.content}</span>`;
            } else {
              questionEl.innerHTML = `
                <span class="text-gray-800">${item.content}</span>
                <span class="flex-1 border-b border-gray-300 mx-2"></span>
              `;
            }
            
            gridElement.appendChild(questionEl);
          }
        });
        
        pageElement.appendChild(gridElement);
        questionsPages.appendChild(pageElement);
      });
      
      // 更新分页数据
      questionPages = newQuestionPages;
    }
    
    function renderAnswerPages() {
      answersContainer.innerHTML = '';
      const colCount = parseInt(colCountInput.value) || 6;
      const fontSize = parseInt(fontSizeInput.value) || 14;
      const isBold = fontBoldCheckbox.checked;
      
      answerPages.forEach((page, pageIndex) => {
        const pageElement = document.createElement('div');
        pageElement.className = `answer-page ${pageIndex === 0 ? '' : 'hidden'} page-shadow rounded-lg p-6 bg-white page-transition`;
        
        pageElement.innerHTML = `
          <h3 class="text-sm text-gray-500 mb-4">
            <span class="lang-zh">答案 - 第 ${pageIndex + 1} 页</span>
            <span class="lang-en hidden">Answers - Page ${pageIndex + 1}</span>
          </h3>
        `;
        
        const gridElement = document.createElement('div');
        gridElement.className = `grid grid-cols-${colCount} gap-3`;
        
        page.forEach((answer, index) => {
          const answerEl = document.createElement('div');
          answerEl.className = `p-3 border border-gray-100 rounded-lg bg-neutral ${isBold ? 'font-bold' : ''}`;
          answerEl.style.fontSize = `${fontSize}px`;
          answerEl.textContent = answer;
          gridElement.appendChild(answerEl);
        });
        
        pageElement.appendChild(gridElement);
        answersContainer.appendChild(pageElement);
      });
    }
    
    function generateQuestions() {
      const questionCount = parseInt(questionCountInput.value);
      const numberRange = parseInt(numberRangeInput.value);
      const fontSize = parseInt(fontSizeInput.value);
      const rowCount = parseInt(rowCountInput.value);
      const colCount = parseInt(colCountInput.value);
      const sectionCount = parseInt(sectionCountInput.value);
      
      [questionCountInput, numberRangeInput, fontSizeInput, rowCountInput, colCountInput, sectionCountInput].forEach(el => {
        el.classList.remove('border-red-500');
      });
      
      if (isNaN(questionCount) || questionCount < 1 || questionCount > 500) {
        showNotification(
          currentLang === 'zh' ? '请输入有效的题目数量（1-500）' : 'Please enter a valid number of questions (1-500)', 
          'error'
        );
        highlightInputError(questionCountInput);
        return;
      }
      
      if (isNaN(numberRange) || numberRange < 10 || numberRange > 1000) {
        showNotification(
          currentLang === 'zh' ? '请输入有效的数字范围（10-1000）' : 'Please enter a valid number range (10-1000)', 
          'error'
        );
        highlightInputError(numberRangeInput);
        return;
      }
      
      if (isNaN(fontSize) || fontSize < 8 || fontSize > 24) {
        showNotification(
          currentLang === 'zh' ? '请输入有效的字号（8-24px）' : 'Please enter a valid font size (8-24px)', 
          'error'
        );
        highlightInputError(fontSizeInput);
        return;
      }
      
      if (isNaN(rowCount) || rowCount < 5 || rowCount > 40) {
        showNotification(
          currentLang === 'zh' ? '请输入有效的行数（5-40）' : 'Please enter a valid number of rows (5-40)', 
          'error'
        );
        highlightInputError(rowCountInput);
        return;
      }
      
      if (isNaN(colCount) || colCount < 1 || colCount > 6) {
        showNotification(
          currentLang === 'zh' ? '请输入有效的列数（1-6）' : 'Please enter a valid number of columns (1-6)', 
          'error'
        );
        highlightInputError(colCountInput);
        return;
      }
      
      if (isNaN(sectionCount) || sectionCount < 1 || sectionCount > 20) {
        showNotification(
          currentLang === 'zh' ? '请输入有效的分段数量（1-20）' : 'Please enter a valid section count (1-20)', 
          'error'
        );
        highlightInputError(sectionCountInput);
        return;
      }
      
      const operations = [];
      if (document.getElementById('addition').checked) operations.push('addition');
      if (document.getElementById('subtraction').checked) operations.push('subtraction');
      if (document.getElementById('multiplication').checked) operations.push('multiplication');
      if (document.getElementById('division').checked) operations.push('division');
      if (document.getElementById('comparison').checked) operations.push('comparison');
      if (document.getElementById('brackets').checked) operations.push('brackets');
      
      if (operations.length === 0) {
        showNotification(
          currentLang === 'zh' ? '请至少选择一种运算类型' : 'Please select at least one operation type', 
          'error'
        );
        return;
      }
      
      initialMessage.classList.add('hidden');
      questionsContainer.classList.add('hidden');
      paginationControls.classList.add('hidden');
      answersContainer.classList.add('hidden');
      answersPaginationControls.classList.add('hidden');
      loadingIndicator.classList.remove('hidden');
      
      setTimeout(() => {
        generatedQuestions = [];
        generatedAnswers = [];
        
        for (let i = 0; i < questionCount; i++) {
          const operationType = operations[Math.floor(Math.random() * operations.length)];
          let questionText, result;
          
          switch (operationType) {
            case 'addition':
              [questionText, result] = generateAdditionQuestion(numberRange);
              break;
            case 'subtraction':
              [questionText, result] = generateSubtractionQuestion(numberRange);
              break;
            case 'multiplication':
              [questionText, result] = generateMultiplicationQuestion(numberRange);
              break;
            case 'division':
              [questionText, result] = generateDivisionQuestion(numberRange);
              break;
            case 'comparison':
              [questionText, result] = generateComparisonQuestion(numberRange);
              break;
            case 'brackets':
              [questionText, result] = generateBracketQuestion(numberRange);
              break;
          }
          
          generatedQuestions.push(questionText);
          generatedAnswers.push(`${questionText} ${result}`);
        }
        
        questionPages = splitIntoPages(generatedQuestions);
        answerPages = splitIntoPages(generatedAnswers);
        
        currentPage = 1;
        currentAnswerPage = 1;
        
        renderQuestionPages();
        renderAnswerPages();
        
        if (currentLang === 'zh') {
          questionStats.textContent = `${questionCount} 题`;
          pageStats.textContent = `${questionPages.length} 页`;
        } else {
          questionStatsEn.textContent = `${questionCount} questions`;
          pageStatsEn.textContent = `${questionPages.length} pages`;
        }
        
        loadingIndicator.classList.add('hidden');
        questionsContainer.classList.remove('hidden');
        paginationControls.classList.remove('hidden');
        
        updatePagination();
        updateAnswerPagination();
        
        showNotification(
          currentLang === 'zh' 
            ? `成功生成 ${questionCount} 道题目，分为 ${sectionCount} 段，共 ${questionPages.length} 页。`
            : `Successfully generated ${questionCount} questions, divided into ${sectionCount} sections, total ${questionPages.length} pages.`, 
          'success'
        );
        
      }, 600);
    }
    
    function highlightInputError(input) {
      input.classList.add('border-red-500');
      setTimeout(() => input.classList.remove('border-red-500'), 2000);
    }
    
    function generateAdditionQuestion(range) {
      const num1 = Math.floor(Math.random() * range) + 1;
      const maxNum2 = Math.min(range - num1, range);
      const num2 = Math.floor(Math.random() * maxNum2) + 1;
      const result = num1 + num2;
      return [`${num1} + ${num2} =`, result];
    }
    
    function generateSubtractionQuestion(range) {
      const num1 = Math.floor(Math.random() * range) + 1;
      const num2 = Math.floor(Math.random() * num1) + 1;
      const result = num1 - num2;
      return [`${num1} - ${num2} =`, result];
    }
    
    function generateMultiplicationQuestion(range) {
      const maxFactor = Math.floor(Math.sqrt(range)) + 1;
      const num1 = Math.floor(Math.random() * maxFactor) + 1;
      const num2 = Math.floor(Math.random() * maxFactor) + 1;
      const result = num1 * num2;
      return [`${num1} × ${num2} =`, result];
    }
    
    function generateDivisionQuestion(range) {
      const num2 = Math.floor(Math.random() * (Math.floor(range / 2) - 1)) + 1;
      const maxQuotient = Math.floor(range / num2);
      const quotient = maxQuotient > 0 ? Math.floor(Math.random() * maxQuotient) + 1 : 1;
      const num1 = num2 * quotient;
      return [`${num1} ÷ ${num2} =`, quotient];
    }
    
    function generateComparisonQuestion(range) {
      const num1 = Math.floor(Math.random() * range) + 1;
      const num2 = Math.floor(Math.random() * range) + 1;
      let operator = num1 > num2 ? ">" : (num1 < num2 ? "<" : "=");
      return [`${num1} ____ ${num2}`, operator];
    }
    
    function generateBracketQuestion(range) {
      const num1 = Math.floor(Math.random() * range / 2) + 1;
      const num2 = Math.floor(Math.random() * range / 2) + 1;
      const num3 = Math.floor(Math.random() * range / 3) + 1;
      
      const innerOps = ["+", "-"];
      const innerOp = innerOps[Math.floor(Math.random() * innerOps.length)];
      const outerOps = ["+", "-", "×"];
      const outerOp = outerOps[Math.floor(Math.random() * outerOps.length)];
      
      let innerResult = innerOp === "+" ? num1 + num2 : Math.max(num1, num2) - Math.min(num1, num2);
      let result;
      
      if (outerOp === "+") result = innerResult + num3;
      else if (outerOp === "-") {
        result = innerResult - num3;
        if (result < 0) {
          result = num3 - innerResult;
          return [`${num3} - (${num1} ${innerOp} ${num2}) =`, result];
        }
      } else result = innerResult * num3;
      
      return [`(${num1} ${innerOp} ${num2}) ${outerOp} ${num3} =`, result];
    }
    
    function exportQuestions() {
      if (generatedQuestions.length === 0) {
        showNotification(
          currentLang === 'zh' ? '请先生成题目' : 'Please generate questions first', 
          'error'
        );
        return;
      }

      const exportFormat = 'pdf';
      const paper = getPaperDimensions();
      const fontSize = parseInt(fontSizeInput.value) || 14;
      const rowCount = parseInt(rowCountInput.value) || 40;
      const colCount = parseInt(colCountInput.value) || 6;
      const includeAnswers = includeAnswersCheckbox.checked;
      const answersOnNewPage = answersOnNewPageCheckbox.checked;
      const isBold = fontBoldCheckbox.checked;
      const sectionCount = parseInt(sectionCountInput.value) || 1;

      const date = new Date();
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      const minute = String(date.getMinutes()).padStart(2, '0');
      const second = String(date.getSeconds()).padStart(2, '0');
      const timeStr = `${year}${month}${day}${hour}${minute}${second}`;
      const numberRange = numberRangeInput.value;
      const fileName = currentLang === 'zh' 
        ? `${numberRange}以内运算题_A4_${timeStr}`
        : `Math_Exercises_Within_${numberRange}_A4_${timeStr}`;

      showNotification(
        currentLang === 'zh' 
          ? `正在导出为PDF格式...` 
          : `Exporting to PDF format...`, 
        'info'
      );
      
      exportBtn.disabled = true;
      exportBtn.innerHTML = `<i class="fa fa-spinner fa-spin mr-2"></i> ${currentLang === 'zh' ? '导出中...' : 'Exporting...'}`;

      exportAsPdf(fileName, paper, fontSize, rowCount, colCount, includeAnswers, answersOnNewPage, isBold, sectionCount);
    }
    
    // 优化：PDF导出支持分段和加粗
    function exportAsPdf(fileName, paper, fontSize, rowCount, colCount, includeAnswers, answersOnNewPage, isBold, sectionCount) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', [paper.width, paper.height]);
      
      try {
        pdf.setFont('notosanssc', isBold ? 'bold' : 'normal');
      } catch (e) {
        console.log('使用默认字体:', e);
        if (isBold) pdf.setFontType('bold');
      }
      
      const fontSizePt = fontSize * 0.75;
      const rowHeight = (fontSize * 1.8) * 0.264583;
      const questionsPerPage = rowCount * colCount;
      
      // 分段处理题目
      [sectionedQuestions, sectionedAnswers] = splitIntoSections(generatedQuestions, generatedAnswers);
      
      // 构建带分段标题的完整题目列表
      let fullQuestions = [];
      sectionedQuestions.forEach((section, sectionIndex) => {
        // 添加分段标题
        fullQuestions.push({
          type: 'title',
          text: currentLang === 'zh' ? `第 ${sectionIndex + 1} 段` : `Section ${sectionIndex + 1}`
        });
        // 添加题目
        section.forEach(q => fullQuestions.push({
          type: 'question',
          text: q
        }));
      });
      
      // 导出题目页面
      let currentY = paper.margin + 10;
      let currentPageNum = 1;
      let questionIndex = 0;
      
      pdf.setFontSize(fontSizePt + 2); // 标题字号稍大
      
      fullQuestions.forEach((item, idx) => {
        if (item.type === 'title') {
          // 绘制分段标题
          if (currentY + rowHeight * 2 > paper.height - paper.margin - 10) {
            pdf.addPage();
            currentY = paper.margin + 10;
            currentPageNum++;
          }
          
          pdf.text(item.text, paper.width / 2, currentY, { align: 'center' });
          currentY += rowHeight * 1.5;
        } else {
          // 绘制题目
          if (questionIndex % questionsPerPage === 0 && questionIndex > 0) {
            pdf.addPage();
            currentY = paper.margin + 10;
            currentPageNum++;
            pdf.setFontSize(fontSizePt);
          }
          
          const col = questionIndex % colCount;
          const row = Math.floor((questionIndex % questionsPerPage) / colCount);
          const x = paper.margin + (col * (paper.contentWidth / colCount)) + 5;
          
          if (currentY + rowHeight > paper.height - paper.margin - 10) {
            pdf.addPage();
            currentY = paper.margin + 10;
            currentPageNum++;
          }
          
          pdf.setFontSize(fontSizePt);
          pdf.text(item.text, x, currentY);
          
          questionIndex++;
          if ((questionIndex % colCount) === 0) {
            currentY += rowHeight;
          }
        }
      });
      
      // 导出答案页面
      if (includeAnswers && answerPages.length > 0) {
        if (answersOnNewPage) {
          pdf.addPage();
          currentY = paper.margin + 10;
          currentPageNum++;
        }
        
        pdf.setFontSize(fontSizePt);
        let answerIndex = 0;
        
        answerPages.forEach((page, pageIndex) => {
          if (pageIndex > 0) {
            pdf.addPage();
            currentY = paper.margin + 10;
            currentPageNum++;
          }
          
          page.forEach((answer, idx) => {
            const col = answerIndex % colCount;
            const row = Math.floor(answerIndex / colCount);
            const x = paper.margin + (col * (paper.contentWidth / colCount)) + 5;
            
            if (currentY + rowHeight > paper.height - paper.margin - 10) {
              pdf.addPage();
              currentY = paper.margin + 10;
              currentPageNum++;
            }
            
            pdf.text(answer, x, currentY);
            
            answerIndex++;
            if ((answerIndex % colCount) === 0) {
              currentY += rowHeight;
            }
          });
        });
      }
      
      pdf.save(`${fileName}.pdf`);
      setTimeout(() => {
        showNotification(
          currentLang === 'zh' ? 'PDF导出成功' : 'PDF exported successfully', 
          'success'
        );
        exportBtn.disabled = false;
        exportBtn.innerHTML = `<i class="fa fa-download mr-2"></i> ${currentLang === 'zh' ? '导出PDF' : 'Export PDF'}`;
      }, 1000);
    }
    
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      
      let bgColor, icon;
      switch(type) {
        case 'success':
          bgColor = 'bg-secondary';
          icon = 'fa-check-circle';
          break;
        case 'error':
          bgColor = 'bg-red-500';
          icon = 'fa-exclamation-circle';
          break;
        case 'info':
        default:
          bgColor = 'bg-primary';
          icon = 'fa-info-circle';
      }
      
      notification.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg fixed bottom-4 right-4 transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50`;
      notification.innerHTML = `
        <i class="fa ${icon} mr-2"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.remove('translate-y-20', 'opacity-0');
      }, 100);
      
      setTimeout(() => {
        notification.classList.add('translate-y-20', 'opacity-0');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const mainContent = document.querySelector('main');
      
      setTimeout(() => {
        mainContent.classList.remove('opacity-0');
      }, 300);

      document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
      });

      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && ['s', 'u', 'c'].includes(e.key.toLowerCase())) {
          e.preventDefault();
        }
      });
    });
  </script>
</body>
</html>
